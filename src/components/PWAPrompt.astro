---
// File: src/components/PWAPrompt.astro
// Based on the official @vite-pwa/astro documentation example
---

<div id="pwa-prompt" role="alert" aria-labelledby="pwa-message">
  <div class="message">
    <span id="pwa-message"></span>
  </div>
  <button id="pwa-refresh" type="button" class="btn btn-primary btn-sm"
    >Odśwież</button
  >
  <button id="pwa-close" type="button" class="btn btn-outline-secondary btn-sm"
    >Zamknij</button
  >
</div>

<script>
  import { registerSW } from 'virtual:pwa-register';

  function setupPWAPrompt() {
    const pwaPrompt = document.querySelector<HTMLDivElement>('#pwa-prompt');
    const pwaMessage =
      pwaPrompt?.querySelector<HTMLSpanElement>('#pwa-message');
    const pwaCloseBtn =
      pwaPrompt?.querySelector<HTMLButtonElement>('#pwa-close');
    const pwaRefreshBtn =
      pwaPrompt?.querySelector<HTMLButtonElement>('#pwa-refresh');

    if (!pwaPrompt || !pwaMessage || !pwaCloseBtn || !pwaRefreshBtn) {
      return;
    }

    let refreshSW: ((reloadPage?: boolean) => Promise<void>) | undefined;

    const refreshCallback = () => refreshSW?.(true);

    const hidePwaPrompt = () => {
      pwaRefreshBtn.removeEventListener('click', refreshCallback);
      pwaPrompt.classList.remove('show');
    };

    const showPwaPrompt = (isRefresh: boolean) => {
      if (isRefresh) {
        pwaRefreshBtn.addEventListener('click', refreshCallback);
        pwaRefreshBtn.style.display = 'inline-block';
      } else {
        pwaRefreshBtn.style.display = 'none';
      }
      pwaPrompt.classList.add('show');
    };

    pwaCloseBtn.addEventListener('click', hidePwaPrompt);

    refreshSW = registerSW({
      onOfflineReady() {
        pwaMessage.innerHTML = 'Aplikacja jest gotowa do pracy offline.';
        showPwaPrompt(false);
      },
      onNeedRefresh() {
        pwaMessage.innerHTML =
          'Dostępna jest nowa wersja. Odśwież, aby zobaczyć zmiany.';
        showPwaPrompt(true);
      },
    });
  }

  document.addEventListener('astro:page-load', setupPWAPrompt);
  setupPWAPrompt();
</script>

<style>
  #pwa-prompt {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    padding: 1rem;
    background-color: var(--bs-light);
    border: 1px solid var(--bs-border-color);
    border-radius: var(--bs-border-radius-lg);
    box-shadow: var(--bs-box-shadow-lg);
    z-index: 1056;
    text-align: left;

    visibility: hidden;
    opacity: 0;
    transform: translateY(1rem);
    transition: all 0.3s ease-in-out;
  }
  #pwa-prompt.show {
    visibility: visible;
    opacity: 1;
    transform: translateY(0);
  }
  #pwa-prompt .message {
    margin-bottom: 0.75rem;
  }
  #pwa-prompt button {
    margin-right: 0.5rem;
  }
</style>
