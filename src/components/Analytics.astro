---
// src/components/Analytics.astro

const CLOUDFLARE_TOKEN = "803401bd51ce41edbededd1d4bd7c15a";
const isProd = import.meta.env.PROD;
---

{
  isProd && (
    <script define:vars={{ token: CLOUDFLARE_TOKEN }}>
      /**
       * This function dynamically reinjects the Cloudflare script into the document head.
       * It's necessary because Astro's View Transitions can remove the script during
       * client-side navigation, which would lead to a loss of analytics tracking.
       */
      function reinjectCloudflareScript() {
        // Find and remove any existing Cloudflare script to avoid duplicates.
        const oldScript = document.querySelector('script[data-cf-beacon]');
        if (oldScript) {
          oldScript.remove();
        }

        // Create a new script element for Cloudflare Insights.
        const newScript = document.createElement('script');
        newScript.defer = true;
        newScript.src = 'https://static.cloudflareinsights.com/beacon.min.js';

        // Set the data-cf-beacon attribute with the token from `define:vars`.
        newScript.setAttribute('data-cf-beacon', JSON.stringify({ token: token }));

        // Add the new script to the document head to activate it.
        document.head.appendChild(newScript);
      }

      // Listen for the `astro:page-load` event, which Astro emits after every
      // client-side navigation is complete.
      document.addEventListener('astro:page-load', reinjectCloudflareScript);

      // Run the function once on the initial, full page load.
      reinjectCloudflareScript();
    </script>
  )
}
