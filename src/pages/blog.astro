---
// src/pages/blog.astro
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';

const allPosts = await getCollection('blog');
allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<Layout title="Blog">
  <main class="container my-5">
    <section id="blog">
      <div class="text-center mb-5">
        <h1 class="display-5">Blog</h1>
        <p class="lead">Artykuły, przemyślenia i tutoriale.</p>
      </div>

      <div class="row">
        {
          allPosts.map((post, index) => (
            <div class="col-md-6 mb-4">
              <article class="card h-100">
                {post.data.coverImage && (
                  <a href={`/blog/${post.slug}`} class="card-img-link">
                    <Image
                      src={post.data.coverImage}
                      alt={post.data.coverAlt || post.data.title}
                      widths={[400, 800, 1200]}
                      sizes="(max-width: 768px) 90vw, (max-width: 1200px) 45vw, 550px"
                      format="avif"
                      quality={80}
                      class="card-img-top object-fit-fill"
                      loading={index < 2 ? 'eager' : 'lazy'}
                      decoding={index < 2 ? 'sync' : 'async'}
                      data-img-index={index}
                    />
                  </a>
                )}

                <div class="card-body d-flex flex-column">
                  <h3 class="card-title">
                    <a
                      href={`/blog/${post.slug}`}
                      class="text-decoration-none text-dark"
                    >
                      {post.data.title}
                    </a>
                  </h3>
                  <p class="text-muted">
                    <small>
                      {post.data.pubDate.toLocaleDateString('pl-PL', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                      })}
                    </small>
                  </p>
                  <p class="card-text">{post.data.description}</p>
                  <a
                    href={`/blog/${post.slug}`}
                    class="btn btn-primary mt-auto"
                  >
                    Czytaj dalej
                  </a>
                </div>
              </article>
            </div>
          ))
        }
      </div>
    </section>
  </main>
  <script is:inline>
    const desktopBreakpoint = 768;
    const numImagesDesktop = 4;

    if (window.innerWidth >= desktopBreakpoint) {
      for (let i = 2; i < numImagesDesktop; i++) {
        // Lazy load the next few images on desktop for better UX.
        // Find the Image component by its data attribute.
        const imageWrapper = document.querySelector(`[data-img-index="${i}"]`);

        if (imageWrapper) {
          // Find the correct <img> tag inside, as it has the loading/decoding attributes.
          const imgTag =
            imageWrapper.tagName === 'IMG'
              ? imageWrapper
              : imageWrapper.querySelector('img');

          if (imgTag) {
            // If found, change attributes to force earlier loading.
            imgTag.loading = 'eager';
            imgTag.decoding = 'sync';
          }
        }
      }
    }
  </script>
</Layout>
